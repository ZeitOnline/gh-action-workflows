name: Test code issues
on:
  workflow_call:
    inputs:
      python-version:
        description: "Run setup-python with this version"
        type: string
        required: false
      node-version:
        description: "Run setup-node with this version"
        type: string
        required: false
jobs:
  precommit:
    name: Pre-Commit
    runs-on: zon-ubuntu-general-dind
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - if: inputs.python-version
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{inputs.python-version}}
      - if: inputs.node-version
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{inputs.node-version}}
      - if: inputs.node-version
        name: Force pre-commit to use the node we just installed
        # I really don't know why pre-commit applies the condition
        # "the exe is not contained in the home directory" when finding binaries,
        # see pre_commit.lang_base.exe_exists()
        run: |
          sudo mkdir -p /opt/node
          sudo ln -s $(which node) /opt/node
          sudo ln -s $(which npm) /opt/node
          echo /opt/node >> $GITHUB_PATH
      - name: Run code checks
        run: uvx pre-commit run --all-files --show-diff-on-failure
